tags: calico, network, Felix, IPIP, BGP

# 09-5.Calico 插件

<!-- TOC -->

- [09-5. Calico 插件](#09-5Calico-插件)
    - [Flannel 插件卸载](#1-Flannel-插件卸载)
    - [Docker 配置修改](#2-Docker-配置修改)
    - [kubelet 配置修改](#3-kubelet-配置修改)
    - [calico 安装](#4-calico-安装)
        - [IPIP 模式](#4.1-IPIP-模式)
        - [BGP 模式](#4.2-BGP-模式)
    - [calico-typha 安装](#5-calico-typha-安装)
    - [参考](#6-参考)
    
<!-- TOC -->
## 1. Flannel 插件卸载
```
sudo systemctl stop flanneld
sudo systemctl disable flanneld
sudo rm -rf /var/run/flannel/
sudo rm -rf /etc/flanneld/cert
sudo ip link del flannel.1
```
## 2. Docker 配置修改
原来的 Docker 配置引用了 Flannel 产生的配置文件，需要删除。
```
cd /etc/systemd/system/

sed -i '/^EnvironmentFile/d' docker.service

systemctl daemon-reload
systemctl restart docker.service
```
## 3. kubelet 配置修改
calico 3.8 默认使用的是 Kubernetes API store，calico 通过 Kubernetes API server 来读取相关信息，而不是直接读写 etcd，这要求 kubelet 必须配置参数 --network-plugin=cni，不然无法正常使用。现象是 pod 使用的都是 docker0 网段的地址，而不是 podCIDR 网段。

```
cd /etc/systemd/system/

sed -i '/--v=2/a\ \ --network-plugin=cni' kubelet.service

sed -i 's/--v=2/--v=2 \\\\/' kubelet.service

systemctl daemon-reload
systemctl restart kubelet.service
```

## 4. calico 安装
### 4.1 IPIP 模式
calico 的默认模式就是 IPIP，优点是可以跨网段组网，缺点是性能略有损耗。  

```
wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml -O

cd /opt/k8s/work/
source /opt/k8s/bin/environment.sh

# 修改 calico 中的 pod IP 网段
sed -i "s~192.168.0.0./16~$CLUSTER_CIDR~" calico.yaml

kubectl apply -f calico.yaml
```

### 4.2 BGP 模式
设置为 BGP 需要修改 ***CALICO_IPV4POOL_IPIP*** 的值，从 ***Always*** 改成 ***Never***。


```
cd /opt/k8s/work/

sed -e '/CALICO_IPV4POOL_IPIP/{n;d}' calico.yaml > calico.yaml

sed -i "/CALICO_IPV4POOL_IPIP/a\ \ \ \ \ \ \ \ \ \ \ \ \ \ value: \"Never\"" calico.yaml

kubectl apply -f calico.yaml
```

**排错：**
反复重装 calico 进行时，容易出现以下问题：
calico 正常工作后 calico-kube-controller 却不能启动，报错：rror getting ClusterInformation: connection is unauthorized: Unauthorized。

只需要清理物理机上的 /var/lib/cni 目录即可。

## 5. calico-typha 安装
calico-typha 是 API server 和 calico Felix 之间的中间层，用作 calico Felix 的代理，作用是在大规模集群中降低 calico Felix 对 API server 的压力，当节点数量多于 50 个时才有必要使用。

**使用建议：每 200 个 Kubernetes 节点创建一个 calico-typha replica，calico-typha 的 replica 数量不要超过 20。**

请根据实际的 Kubernetes 集群节点数量设置 TYPHA_REPLICA，以下的步骤中默认为 1。

```
cd /opt/k8s/work/

curl https://docs.projectcalico.org/v3.8/manifests/calico-typha.yaml -O

TYPHA_REPLICA=1
sed -i "s/replicas: 1/replicas: $TYPHA_REPLICA/" calico-typha.yaml

kubectl apply -f calico-typha.yaml
```


## 6. 参考
* [Calico with Kubernetes API datastore](https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/kubernetes-datastore/)
* [Installing Calico 3.6 in Kubernetes results in error in calico-kube-controllers](https://github.com/projectcalico/calico/issues/2597)
* [Configuring IP-in-IP](https://docs.projectcalico.org/v3.8/getting-started/kubernetes/installation/config-options#switching-from-ip-in-ip-to-vxlan)
* [Create a CustomResourceDefinition](https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#create-a-customresourcedefinition)
* [BGP configuration](https://docs.projectcalico.org/v3.8/reference/resources/bgpconfig)
* [k8s网络calico——BGP模式](https://www.cnblogs.com/jinxj/p/9414830.html)
* [calico 二进制安装](https://docs.projectcalico.org/v3.8/getting-started/kubernetes/installation/integration)
* [selecting your datastore type and number of nodes](https://docs.projectcalico.org/v3.8/getting-started/kubernetes/installation/calico#selecting-your-datastore-type-and-number-of-nodes)
